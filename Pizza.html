<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Gráfico de Ocorrências por Freguesia e Ano</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<input type="file" id="csvFileInput" accept=".csv" onchange="loadCSV(event)">
<div>
  <label for="yearSelect">Selecione o ano:</label>
  <select id="yearSelect" onchange="updateChart()"></select>
</div>
<div>
  <label for="fregiSelect">Selecione a região:</label>
  <select id="fregiSelect" onchange="updateChart()"></select>
</div>

<canvas id="occurrencesChart" width="400" height="400"></canvas>

<script>
let data = {};
let occurrencesChart;
let fregiData = {};
const colors = [
  '#FF6633', '#FFB399', '#FF33FF', '#FFFF99', '#00B3E6', 
  '#E6B333', '#3366E6', '#999966', '#99FF99', '#B34D4D',
  '#80B300', '#809900', '#E6B3B3', '#6680B3', '#66991A', 
  '#FF99E6', '#CCFF1A', '#FF1A66', '#E6331A', '#33FFCC',
  '#66994D', '#B366CC', '#4D8000', '#B33300', '#CC80CC', 
  '#66664D', '#991AFF', '#E666FF', '#4DB3FF', '#1AB399',
  '#E666B3', '#33991A', '#CC9999', '#B3B31A', '#00E680', 
  '#4D8066', '#809980', '#E6FF80', '#1AFF33', '#999933',
  '#FF3380', '#CCCC00', '#66E64D', '#4D80CC', '#9900B3', 
  '#E64D66', '#4DB380', '#FF4D4D', '#99E6E6', '#6666FF',
];

// Função para ler o arquivo CSV
function loadCSV(event) {
    const file = event.target.files[0];
    const reader = new FileReader();
  
    reader.onload = function(e) {
      const text = e.target.result;
      processData(text);
    };
  
    reader.readAsText(file);
  }
  
  // Função para processar os dados CSV
  function processData(csvText) {
    const rows = csvText.split('\n').slice(1); // Ignora o cabeçalho
    rows.forEach(row => {
      const columns = row.split(';');
      const fmun = columns[0];
      const fregi = columns[1];
      const year = columns[2];
      const occurrences = parseInt(columns[3]); // Ajuste o índice se necessário
  
      if (!data[year]) {
        data[year] = {};
      }
      if (!data[year][fregi]) {
        data[year][fregi] = {};
      }
      if (!data[year][fregi][fmun]) {
        data[year][fregi][fmun] = 0;
      }
      data[year][fregi][fmun] += occurrences;
  
      if (!fregiData[fregi]) {
        fregiData[fregi] = true;
      }
    });
  
    initYearOptions();
    initFregiOptions();
    updateChart();
  }
  
  // Função para inicializar as opções de ano
  function initYearOptions() {
    const yearSelect = document.getElementById('yearSelect');
    yearSelect.innerHTML = ''; // Limpa as opções existentes
    Object.keys(data).forEach(year => {
      const option = document.createElement('option');
      option.value = year;
      option.textContent = year;
      yearSelect.appendChild(option);
    });
  }
  
  // Função para inicializar as opções de freguesia
  function initFregiOptions() {
    const fregiSelect = document.getElementById('fregiSelect');
    fregiSelect.innerHTML = ''; // Limpa as opções existentes
    Object.keys(fregiData).forEach(fregi => {
      const option = document.createElement('option');
      option.value = fregi;
      option.textContent = fregi;
      fregiSelect.appendChild(option);
    });
  }
  
  // Opções do gráfico, incluindo o título
  const chartOptions = {
    responsive: true,
    plugins: {
      legend: {
        position: 'top',
      },
      title: {
        display: true,
        text: 'Registro de ocorrências por região ao longo dos anos',
        font: {
          size: 18
        }
      }
    }
  };
  
  // Função para atualizar o gráfico
  function updateChart() {
    const yearSelect = document.getElementById('yearSelect');
    const fregiSelect = document.getElementById('fregiSelect');
    const selectedYear = yearSelect.value;
    const selectedFregi = fregiSelect.value;
    const occurrencesData = data[selectedYear][selectedFregi];
  
    const labels = Object.keys(occurrencesData);
    const values = Object.values(occurrencesData);
  
    if (occurrencesChart) {
      occurrencesChart.destroy();
    }
  
    occurrencesChart = new Chart(document.getElementById('occurrencesChart').getContext('2d'), {
      type: 'pie',
      data: {
        labels: labels,
        datasets: [{
          label: 'Ocorrências',
          data: values,
          backgroundColor: colors.slice(0, labels.length) // Usa apenas as cores necessárias
        }]
      },
      options: chartOptions
    });
  }
  
  </script>
  
  </body>
  </html>